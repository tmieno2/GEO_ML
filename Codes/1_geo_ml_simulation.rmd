# Set up

## Packages
```{r }

# /*===========================================================
#' # Preparation
# /*===========================================================
#* set up python environment
library(reticulate)

#* packages
library(sp)
library(spdep)
library(spatialreg)
library(sf)
library(raster)
library(data.table)
library(tidyverse)
library(dplyr)
library(magrittr)
library(gstat)
library(GWmodel)
library(scam)
library(mgcv)
library(magic)
library(stringr)
library(ggplot2)
library(tictoc)
library(here)
```

## Other preparations 
```{r }
#* set working directory
setwd(here())

#* source all the R functions in the Functions/R folder
fs::dir_ls(here("Codes", "Functions", "R"), full.names = TRUE) %>%
  purrr::map(~ source(.))

#* source all the python functions in the Functions/Python folder
# source_python(here("Codes", "Functions", "Python"))
source_python(here("Codes", "Functions", "Python", "run_DML_OF.py"))
source_python(here("Codes", "Functions", "Python", "run_DR_OF.py"))
```

# Simulation Analysis

## Prepare data
```{r }
#* Read field data
field_data <-
  readRDS(here("Data/field_data.rds")) %>%
  pull(field_sf) %>%
  .[[1]]

#* Read field parameters
field_parameters <- readRDS(here("Data/field_parameters.rds"))

#* Read field data
field_with_design <- readRDS(here("Data/field_with_design.rds"))

#* Read the simulated data
sim_data <-
  field_with_design$data_file_name %>%
  readRDS()
```

## Find true optimal N

```{r }
#* define prices
pN <- sim_data$pN
pCorn <- sim_data$pCorn

#* find true EONR
field_pars <-
  field_parameters$field_pars %>%
  rbindlist() %>%
  .[, opt_N := (pN / pCorn - b1) / (2 * b2)] %>%
  .[, opt_N := pmin(Nk, opt_N)] %>%
  .[, opt_N := pmax(0, opt_N)]
```

Quick visualiation of site-specific EONR

```{r }
sim_i <- 1
temp <-
  left_join(field_data, field_pars[sim == sim_i, ], by = "cell_id") %>%
  left_join(., gwr_beta, by = "aunit_id")

ggplot(data = temp) +
  geom_sf(aes(fill = opt_N), color = NA) +
  scale_fill_viridis_c()
```

## Define simulation function

```{r }

run_analysis <- function(sim_i, pN, pCorn) {

  # /*+++++++++++++++++++++++++++++++++++
  #' ## Prepare data
  # /*+++++++++++++++++++++++++++++++++++
  #* extract the data for the sim_i
  temp_data <- sim_data$reg_data[[1]][sim == sim_i, ]

  #* define parameters
  N_levels <- temp_data$N_levels[[1]]
  reg_data <- temp_data$data[[1]]

  # /*+++++++++++++++++++++++++++++++++++
  #' ## GWR
  # /*+++++++++++++++++++++++++++++++++++
  gwr_results <- run_GWR_analysis(reg_data, N_levels, pN, pCorn)

  # /*+++++++++++++++++++++++++++++++++++
  #' ## DROF 
  # /*+++++++++++++++++++++++++++++++++++
  N_tgt_rank_data <-
    reg_data[, .(N_tgt = unique(N_tgt))] %>%
    .[, N_tgt_rank := rank(N_tgt) - 1]

  base_tgt_rate <- N_tgt_rank_data[N_tgt_rank == 0, N_tgt]

  reg_data <- N_tgt_rank_data[reg_data, on = "N_tgt"]

  Y <- reg_data[, yield] %>% as.array() #* dependent var
  T <- reg_data[, N_tgt_rank] %>% as.array() #* treatment
  X <- reg_data[, .(X, Y)] %>% as.matrix() #* het impact driver
  # X <- reg_data[, .(b0, b1, b2, Nk)] %>% as.matrix() #* het impact driver
  # W <- reg_data[, .(b0, b1, b2, Nk, X, Y)] %>% as.matrix() #* het impact driver
  W <- X #* controls

  #* Define some hyper parameters
  subsample_ratio <- 0.3
  lambda_reg <- sqrt(log(ncol(W)) / (10 * subsample_ratio * nrow(Y)))

  #* estimate Doubly-Robus Orthogonal Forest
  DR_OF_res <-
    run_DR_OF(
      Y = Y,
      T = T,
      X = X,
      W = W,
      X_test = X,
      se = FALSE,
      subsample_ratio = subsample_ratio,
      lambda_reg = lambda_reg
    )

  #* make tau to a data.table
  tau_hat <-
    DR_OF_res %>%
    data.table()

  #* assign the estimated impact to analysis units
  tau_data <-
    cbind(reg_data[, .(aunit_id)], tau_hat) %>%
    melt(id.var = "aunit_id") %>%
    setnames("value", "tau") %>%
    .[, N_tgt_rank := gsub("V", "", variable) %>% as.numeric()] %>%
    N_tgt_rank_data[., on = "N_tgt_rank"] %>%
    .[, .(aunit_id, N_tgt, tau)] %>%
    .[, sim := sim_i]

  eonr_drof <-
    tau_data %>%
    .[, pi_delta := pCorn * tau - pN * N_tgt] %>%
    .[, .SD[which.max(pi_delta), ], by = aunit_id] %>%
    setnames("N_tgt", "opt_N_drof") %>%
    .[pi_delta < 0, opt_N_drof := base_tgt_rate] %>%
    .[, .(aunit_id, opt_N_drof)]

  drof_results <- eonr_drof[tau_data, on = "aunit_id"]

  return(return_data)
}

```


```{r }
sim_i <- 1
tau_data <- run_analysis(sim_i = sim_i)


field_tau <-
  field_data %>%
  left_join(., drof_results, by = "aunit_id") %>%
  left_join(., gwr_results, by = "aunit_id") %>%
  filter(!is.na(N_tgt)) %>%
  left_join(., field_pars[sim == sim_i, ], by = "cell_id")

ggplot(field_tau) +
  geom_sf(aes(fill = tau), color = NA) +
  facet_grid(N_tgt ~ .) +
  scale_fill_viridis_c()

ggplot(field_tau) +
  geom_sf(aes(fill = opt_N), color = NA) +
  scale_fill_viridis_c()

ggplot(field_tau) +
  geom_sf(aes(fill = factor(opt_N_drof)), color = NA) +
  scale_fill_viridis_d()

ggplot(field_tau) +
  geom_sf(aes(fill = opt_N_gwr), color = NA) +
  scale_fill_viridis_c()

aunit_ls <- tau_data$aunit_id %>% unique()

tau_data[aunit_id == aunit_ls[200], ] %>%
  ggplot(data = .) +
  geom_line(aes(y = tau, x = N_tgt)) +
  geom_point(aes(y = tau, x = N_tgt))

ggplot(reg_data) +
  geom_point(aes(y = yield, x = N)) +
  ylim(0, NA)
```